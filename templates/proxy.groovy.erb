import java.lang.System;
import jenkins.*
import jenkins.model.*
import hudson.*
import hudson.model.*

////////////////////////////////////////////////////////////////////////////////
// defines which puppet provides
////////////////////////////////////////////////////////////////////////////////
def hostname = "<%= @proxy_hostname %>"
def port = <%= @proxy_port %>
def userName = "<%= @proxy_user_name %>"
def password = "<%= @proxy_password %>"
def noProxyHost = "<%= @no_proxy_host_list.join(" ") %>"
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Header for log
////////////////////////////////////////////////////////////////////////////////
println("########## START: proxy config: ${hostname}:${port} ##########")
////////////////////////////////////////////////////////////////////////////////

assert hostname.length() > 0
assert port > 0
assert port < 65536

class ProxyConfig {

  def jenkinsInstance = jenkins.model.Jenkins.getInstance()
  def updateCenter = jenkinsInstance.getUpdateCenter()

  public ProxyConfig (hostname, port, userName, password, noProxyHost) {
    def proxyConfig = new hudson.ProxyConfiguration(hostname, port, userName, password, noProxyHost);
    jenkinsInstance.proxy = proxyConfig
    proxyConfig.save()
    System.out.println("Proxy settings set and saved!")
  }

  public void updateAllSites() {
    System.out.println("Updating update center metadata file")
    updateCenter.updateAllSites()
    System.out.println("Updating update center metadata file [done]")
  }
}

def proxy = new ProxyConfig(hostname, port, userName, password, noProxyHost)
proxy.updateAllSites()
////////////////////////////////////////////////////////////////////////////////
// Footer for log
////////////////////////////////////////////////////////////////////////////////
println("########## END: proxy config ##########")
////////////////////////////////////////////////////////////////////////////////
